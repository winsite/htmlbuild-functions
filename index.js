'use strict';

var wait = function (stream, callback) {
	var chunks = [];

	stream.on('error', function (err) {
		callback(error);
	});

	stream.on('data', function (chunk) {
		chunks.push(chunk);
	});

	stream.on('end', function () {
		var data = chunks.join('');
		callback(null, data);
	});

	stream.resume();
};

var readFile = function (cwd) {
	var fs = require('fs'),
		path = require('path'),
		through2 = require('through2'),
		File = require('vinyl');

	return through2.obj(function (chunk, end, callback) {
		var filename = path.join(cwd || '', chunk);
		fs.readFile(filename, function (err, data) {
			if (err) {
				callback(err);
				return;
			}
			var file = new File({
				path: filename,
				contents: data
			});
			console.log(file);
			callback(null, file);
		});
	});
};

var scriptSrc = function (html, min) {
	var stream = require('stream'),
		cheerio = require('cheerio'),
		readable = new stream.Readable({objectMode: true}),
		$ = cheerio.load(html);

	$('link[rel=stylesheet][href]').each(function () {
		var element = $(this),
			href;
		if (min) {
			href = element.attr('min-href') || element.attr('data-min-href');
		}
		href = href || element.attr('target-href') || element.attr('data-target-href') || element.attr('href');
		href && readable.push(href);
	});
	readable.push(null);
	return readable;
};

var stylesheetSrc = function (html, min) {
	var stream = require('stream'),
		cheerio = require('cheerio'),
		readable = new stream.Readable({objectMode: true}),
		$ = cheerio.load(html);

	$('script[src]').each(function () {
		var element = $(this),
			href;
		if (min) {
			href = element.attr('min-src') || element.attr('data-min-src');
		}
		href = href || element.attr('target-src') || element.attr('data-target-src') || element.attr('src');
		href && readable.push(href);
	});
	readable.push(null);
	return readable;
};

module.exports = {

	/**
	 * Builder pro vytvoøení streamu se seznamem všech skriptù
	 * @param stream	Výstupní stream
	 * @param cwd	Pracovní adresáø
	 * @param min	Použít minifikované verze sriptù
	 * @returns {Function}
	 */
	streamScript: function (stream, cwd, min) {
		min = min !== false;
		return function (block) {
			wait(block, function (err, html) {
				if (err) throw err;
				scriptSrc(html, min)
					.pipe(readFile(cwd))
					.pipe(stream);
			});
		};
	},

	/**
	 * Builder pro vytvoøení streamu se seznamem všech souborù se styly
	 * @param stream	Výstupní stream
	 * @param cwd	Pracovní adresáø
	 * @param min	Použít minifikované verze souborù se styly
	 * @returns {Function}
	 */
	streamStylesheet: function (stream, cwd, min) {
		min = min !== false;
		return function (block) {
			wait(block, function (err, html) {
				if (err) throw err;
				stylesheetSrc(html, min)
					.pipe(readFile(cwd))
					.pipe(stream);
			});
		};
	},

	/**
	 * Builder pro nahrazení sekce scriptù za souhrnný script tag
	 * @param src	Hodnota src atributu
	 * @returns {Function}
	 */
	replaceScript: function (src) {
		return function (block) {
			var cheerio = require('cheerio'),
				element = cheerio('<script></script>');
			element.attr('src', src);
			block.end(block.indent + cheerio.html(element));
		};
	},

	/**
	 * Builder pro nahrazení sekce stylù za souhrnný script link
	 * @param href	Hodnota href atributu
	 * @returns {Function}
	 */
	replaceStylesheet: function (href) {
		return function (block) {
			var cheerio = require('cheerio'),
				element = cheerio('<link>');
			element.attr('rel', 'stylesheet');
			element.attr('href', href);
			block.end(block.indent + cheerio.html(element));
		};
	}
};